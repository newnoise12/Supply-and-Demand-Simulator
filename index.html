<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mill King!</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0 auto;
      max-width: 800px;
      padding: 20px;
      background: linear-gradient(to bottom right, #1e1e1e, #2c2c2c);
      color: #f0f0f0;
    }
    .section {
      border: 1px solid #555;
      background-color: #3b3b3b;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }
    button {
      padding: 10px 16px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    select, input {
      padding: 8px;
      border-radius: 5px;
      background-color: #222;
      color: white;
      margin-top: 5px;
      margin-bottom: 10px;
    }
    h1 { text-align: center; color: #77dd77; }
    h2 { color: #add8e6; }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #1f1f1f;
    }
    th, td {
      border: 1px solid #666;
      padding: 8px;
      text-align: center;
    }
    th { background-color: #333; }
  </style>
</head>

<body>
<h1>üè≠ Mill King!</h1>

<div class="section">
  <label>Select Group:</label>
  <select id="group-select" onchange="loadGroupState()">
    <option value="groupA">Group A</option>
    <option value="groupB">Group B</option>
    <option value="groupC">Group C</option>
    <option value="groupD">Group D</option>
    <option value="groupE">Group E</option>
  </select>
  <p>
    Cash: <span id="cash-display">¬£0</span> |
    Labour: <span id="labour-display">0</span> |
    Materials: <span id="materials-display">0</span>
  </p>
</div>

<div class="section">
  <h2>Buy Materials</h2>
  <label>Price: <span id="material-price">¬£3</span>/unit</label><br>
  <input type="number" id="materials-to-buy" value="1" min="1">
  <button onclick="buyMaterials()">Buy</button>
  <p id="materialOutput"></p>
</div>

<div class="section">
  <h2>Production</h2>
  <input type="number" id="units" value="1" min="1">
  <button onclick="simulateProduction()">Produce</button>
  <p id="prodOutput"></p>
</div>

<div class="section">
  <h2>Set Price</h2>
  <input type="number" id="price" value="10" min="1">
  <button onclick="submitPrice()">Submit</button>
  <p id="priceOutput"></p>
</div>

<div class="section">
  <h2>üì£ Market Feedback</h2>
  <p id="group-feedback">Awaiting market resolution‚Ä¶</p>
</div>

<div class="section">
  <button onclick="resolveMarket()">Resolve Market</button>
  <p>Round: <span id="current-round-display">1</span></p>
</div>

<div class="section">
  <h2>Group Overview</h2>
  <table>
    <thead>
      <tr>
        <th>Group</th><th>Cash</th><th>Labour</th><th>Materials</th>
      </tr>
    </thead>
    <tbody id="resource-table"></tbody>
  </table>
</div>

<div id="eventModal" style="display:none; position:fixed; inset:0; background:black; color:white; padding:40px;">
  <h2 id="eventText"></h2>
  <button onclick="closeEventModal()">Start Round</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCCtJVh4kOMu7l0mhQcjRcTUg_cL9KD6q0",
  authDomain: "supply-demand-sim.firebaseapp.com",
  databaseURL: "https://supply-demand-sim-default-rtdb.firebaseio.com",
  projectId: "supply-demand-sim"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentRound = 1;
const MAX_ACCEPTABLE_PRICE = 20;
const groupList = ['groupA','groupB','groupC','groupD','groupE'];

function getInitialLabor(round){ return 25 + (round-1)*5; }

const defaultState = { cash:100, labor:getInitialLabor(1), materials:0 };
let currentMaterialPrice = 3;

const demandModifiers = [
  {round:1, baseDemand:100, materialPrice:3, message:"Stable economy"},
  {round:2, baseDemand:80, materialPrice:4, message:"Flood raises costs"},
  {round:3, baseDemand:130, materialPrice:3, message:"Population boom"},
  {round:4, baseDemand:90, materialPrice:5, message:"Tariffs imposed"},
  {round:5, baseDemand:120, materialPrice:2, message:"Cheaper inputs"},
  {round:6, baseDemand:70, materialPrice:3, message:"Market saturation"}
];

function ensureAllGroupsInitialized(){
  return Promise.all(groupList.map(g =>
    db.ref(`groups/${g}/state`).once("value").then(s=>{
      if(!s.exists()) db.ref(`groups/${g}/state`).set(defaultState);
    })
  ));
}

function loadGroupState(){
  const g = groupSelect.value;
  db.ref(`groups/${g}/state`).once("value").then(s=>{
    const st=s.val()||defaultState;
    cashDisplay.textContent=`¬£${st.cash}`;
    labourDisplay.textContent=st.labor;
    materialsDisplay.textContent=st.materials;
  });

  db.ref(`groups/${g}/round${currentRound}/feedback`).once("value").then(s=>{
    groupFeedback.textContent = s.val() || "Awaiting market resolution‚Ä¶";
  });
}

function updateOverviewTable(){
  resourceTable.innerHTML="";
  groupList.forEach(g=>{
    db.ref(`groups/${g}/state`).once("value").then(s=>{
      const st=s.val()||defaultState;
      resourceTable.innerHTML+=`<tr><td>${g}</td><td>¬£${st.cash}</td><td>${st.labor}</td><td>${st.materials}</td></tr>`;
    });
  });
}

function buyMaterials(){
  const g=groupSelect.value;
  const q=+materialsToBuy.value;
  const cost=q*currentMaterialPrice;
  db.ref(`groups/${g}/state`).once("value").then(s=>{
    const st=s.val();
    if(st.cash>=cost){
      db.ref(`groups/${g}/state`).update({cash:st.cash-cost, materials:st.materials+q});
      materialOutput.textContent=`Bought ${q} units`;
      loadGroupState(); updateOverviewTable();
    }
  });
}

function simulateProduction(){
  const g=groupSelect.value;
  const u=+units.value;
  db.ref(`groups/${g}/state`).once("value").then(s=>{
    const st=s.val();
    if(st.labor>=u*2 && st.materials>=u){
      db.ref(`groups/${g}/state`).update({labor:st.labor-u*2, materials:st.materials-u});
      prodOutput.textContent=`Produced ${u}`;
      loadGroupState(); updateOverviewTable();
    }
  });
}

function submitPrice(){
  const g=groupSelect.value;
  const p=+price.value;
  const u=+units.value;
  db.ref(`groups/${g}/round${currentRound}`).set({price:p, produced:u});
}

function resolveMarket(){
  const event=demandModifiers.find(e=>e.round===currentRound);
  const baseDemand=event.baseDemand;
  db.ref("groups").once("value").then(s=>{
    const groups=s.val();
    let total=0;
    for(let g in groups){
      const r=groups[g][`round${currentRound}`];
      if(r) total+=r.produced||0;
    }
    const demand=Math.floor(baseDemand*(1-total/150));
    for(let g in groups){
      const r=groups[g][`round${currentRound}`];
      if(!r) continue;
      let feedback="";
      let sold=0, revenue=0;
      if(r.price>MAX_ACCEPTABLE_PRICE){
        feedback="‚ùå Price too high ‚Äì no sales.";
      } else {
        sold=Math.min(r.produced, Math.floor((r.produced/total)*demand));
        revenue=sold*r.price;
        feedback=sold===0?"‚ùå No sales":sold<r.produced?"‚ö†Ô∏è Partial sales":"‚úÖ Sold all units";
      }
      db.ref(`groups/${g}/state`).update({
        cash:groups[g].state.cash+revenue,
        labor:getInitialLabor(currentRound+1)
      });
      db.ref(`groups/${g}/round${currentRound}`).update({sold,revenue,feedback});
    }
    currentRound++;
    currentRoundDisplay.textContent=currentRound;
    loadGroupState(); updateOverviewTable();
  });
}

window.onload=()=>ensureAllGroupsInitialized().then(()=>loadGroupState());
</script>
</body>
</html>

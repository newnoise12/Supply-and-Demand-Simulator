<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Supply & Demand Simulator</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0 auto;
      max-width: 800px;
      padding: 20px;
      background-color: #2c2c2c;
      color: #f0f0f0;
      background-image: url('https://www.transparenttextures.com/patterns/asfalt-dark.png');
    }
    h1, h2 {
      text-align: center;
    }
    .section {
      border: 1px solid #555;
      background-color: #3b3b3b;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
    button {
      padding: 10px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background: #45a049;
    }
    textarea {
      width: 100%;
      height: 150px;
      background-color: #1f1f1f;
      color: #fff;
      border: 1px solid #666;
    }
    .group-selector {
      background-color: #444;
      padding: 10px;
      margin-top: 10px;
      border-radius: 8px;
      border: 1px solid #666;
    }
    .group-selector label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
    }
    #group-select {
      padding: 6px 12px;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #999;
      background-color: #222;
      color: #fff;
    }
    .event-box {
      background-color: #5a4646;
      border: 2px dashed #c9a96d;
      padding: 15px;
      margin: 20px 0;
      border-radius: 10px;
      font-size: 1.1rem;
    }
    #splash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.95);
      color: #f0e6d2;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      text-align: center;
      padding: 40px;
    }
    #splash h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    #splash button {
      background-color: #c49e60;
      border: none;
      padding: 10px 20px;
      font-size: 1rem;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="splash">
    <h1>ğŸ§µ The Mill on Calder Street (1810)</h1>
    <p>You are a textile mill owner in Yorkshire during the Industrial Revolution. Manage labor, materials, and machinery while navigating market shocks, worker unrest, and unpredictable events. Compete with rival mill owners to sell cloth and survive industrial capitalism.</p>
    <button onclick="startGame()">Enter the Simulation</button>
  </div>

  <h1>ğŸ“Š Supply & Demand Simulator</h1>

  <div class="section">
    <h2>Instructor Controls</h2>
    <button onclick="triggerEvent()">ğŸ² Trigger Event</button>
    <button onclick="nextRound()">ğŸ”„ Next Round</button>
    <p>Current Round: <strong id="round-display">1</strong></p>
    <div id="event-display" class="event-box" style="display:none;"></div>
  </div>

  <div class="section">
    <h2>Your Resources</h2>
    <p>Cash: <strong id="cash-display">Â£100</strong> | Labour: <strong id="labour-display">10</strong> | Materials: <strong id="materials-display">5</strong></p>
    <div class="group-selector">
      <label for="group-select">Select your group:</label>
      <select id="group-select" onchange="loadGroupState()">
        <option value="groupA">Group A</option>
        <option value="groupB">Group B</option>
        <option value="groupC">Group C</option>
      </select>
    </div>
  </div>

  <div class="section">
    <h2>Production</h2>
    <p>Cost per unit: Â£5 (2 labour, 1 material)</p>
    <label>Units to produce:</label>
    <input type="number" id="units" value="1" min="1">
    <button onclick="simulateProduction()">Produce</button>
    <p id="prodOutput"></p>
  </div>

  <div class="section">
    <h2>Set Your Price</h2>
    <label>Price per unit:</label>
    <input type="number" id="price" value="10" min="1">
    <button onclick="submitPrice()">Submit Price</button>
    <p id="priceOutput"></p>
  </div>

  <div class="section">
    <h2>Leaderboard</h2>
    <textarea readonly id="leaderboard"></textarea>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCCtJVh4kOMu7l0mhQcjRcTUg_cL9KD6q0",
      authDomain: "supply-demand-sim.firebaseapp.com",
      projectId: "supply-demand-sim",
      storageBucket: "supply-demand-sim.firebasestorage.app",
      messagingSenderId: "370392861384",
      appId: "1:370392861384:web:3e142dac960d98f7b073fd",
      measurementId: "G-P602EV8WKN",
      databaseURL: "https://supply-demand-sim-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentRound = 1;

    function startGame() {
      document.getElementById('splash').style.display = 'none';
      loadGroupState();
    }

    function nextRound() {
      currentRound++;
      document.getElementById("round-display").textContent = currentRound;
    }

    function simulateProduction() {
      const units = parseInt(document.getElementById('units').value);
      const groupId = document.getElementById('group-select').value;
      const cost = units * 5;
      const labourNeeded = units * 2;
      const materialsNeeded = units * 1;

      db.ref(`groups/${groupId}/state`).once("value").then(snapshot => {
        const state = snapshot.val();
        if (state.labor >= labourNeeded && state.materials >= materialsNeeded && state.cash >= cost) {
          const newCash = state.cash - cost;
          const newLabor = state.labor - labourNeeded;
          const newMaterials = state.materials - materialsNeeded;

          db.ref(`groups/${groupId}/state`).set({
            cash: newCash,
            labor: newLabor,
            materials: newMaterials
          });

          document.getElementById("cash-display").textContent = `Â£${newCash}`;
          document.getElementById("labour-display").textContent = newLabor;
          document.getElementById("materials-display").textContent = newMaterials;

          document.getElementById('prodOutput').textContent = `You produced ${units} units for Â£${cost}.`;
        } else {
          document.getElementById('prodOutput').textContent = `Not enough resources to produce.`;
        }
      });
    }

    function submitPrice() {
      const price = parseFloat(document.getElementById('price').value);
      const produced = parseInt(document.getElementById('units').value);
      const groupId = document.getElementById('group-select').value;
      const roundKey = `round${currentRound}`;

      db.ref(`groups/${groupId}/${roundKey}`).set({
        price,
        produced,
        timestamp: Date.now()
      });

      document.getElementById("priceOutput").textContent = `Submitted: Â£${price} per unit.`;
    }

    function loadGroupState() {
      const groupId = document.getElementById('group-select').value;
      db.ref(`groups/${groupId}/state`).once("value").then(snapshot => {
        const state = snapshot.val();
        if (state) {
          document.getElementById("cash-display").textContent = `Â£${state.cash}`;
          document.getElementById("labour-display").textContent = state.labor;
          document.getElementById("materials-display").textContent = state.materials;
        }
      });
    }

    db.ref("groups").on("value", (snapshot) => {
      const data = snapshot.val();
      let leaderboard = "";
      for (let group in data) {
        const rounds = Object.entries(data[group]).filter(([k]) => k.startsWith("round"));
        const last = rounds.pop();
        if (last) {
          const [round, stats] = last;
          const cash = data[group].state ? data[group].state.cash : "?";
          leaderboard += `${group} â€” Â£${cash} | Units: ${stats.produced} @ Â£${stats.price}\n`;
        }
      }
      document.getElementById("leaderboard").value = leaderboard;
    });

    function triggerEvent() {
      const events = [
        { title: "ğŸ§µ Luddite Sabotage", description: "Production is blocked this round â€” machines are damaged." },
        { title: "ğŸ“‰ Market Crash in Leeds", description: "Max price drops to Â£10 â€” no one will pay more." },
        { title: "ğŸ‘® Factory Inspection", description: "Any group using child labor is fined Â£25." },
        { title: "ğŸ›ï¸ Demand Surge in London", description: "Cloth sells for 2Ã— price â€” bonus revenue round." },
        { title: "ğŸ§¶ Cotton Shipment Lost at Sea", description: "No new materials â€” groups may not produce new units." },
        { title: "â›… Flooding Halts Work", description: "Production is paused for all groups this round." }
      ];

      const randomEvent = events[Math.floor(Math.random() * events.length)];
      const display = document.getElementById("event-display");
      display.style.display = "block";
      display.innerHTML = `<strong>${randomEvent.title}</strong><br>${randomEvent.description}`;
    }
  </script>
</body>
</html>
